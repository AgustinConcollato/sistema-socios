<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sistema de socios</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="./css/nav.css">
  <link rel="stylesheet" href="./css/header.css">
  <link rel="stylesheet" href="./css/partnerList.css">
  <link rel="stylesheet" href="./css/partnerPayments.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
    integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="../scripts/addPayment.js"></script>
  <script src="../scripts/formatNumber.js"></script>
</head>

<body>
  <header>
    <nav>
      <div class="container-logo">
        <img src="../assets/img/logo.png" />
      </div>
      <ul>
        <li><a href='#'>Socios</a></li>
        <li><a href='./debitAutomatic.html'>Débito automático</a></li>
        <li><a href='./payroll.html'>Planillas</a></li>
      </ul>
    </nav>
    <!-- <div class="searcher">
        <label for="search">
          <i class="fa-solid fa-magnifying-glass"></i>
        </label>
        <input type="text" id="search" placeholder="Buscar por nombre, apellido o número de socio" />
        <div class="response"></div>
      </div> -->
    <button class='btn' id="newPartner">+ Nuevo socio</button>
  </header>
  <section>
    <h1>Socios</h1>
    <div class="filters">
      <div>
        <span>Lugar de pago</span>
        <div class="container-select">
          <select id="collect">
            <option value="1">Secretaría parroquial</option>
            <option value="2">Cobrador</option>
          </select>
          <i class="fa-solid fa-angle-down"></i>
        </div>
      </div>
      <div>
        <span>Estado</span>
        <div class="container-select">
          <select id="status">
            <option value="active">Activo</option>
            <option value="pause">Pausado</option>
          </select>
          <i class="fa-solid fa-angle-down"></i>
        </div>
      </div>
    </div>
    <div class="container-main">
      <div id="partner-list">
      </div>
      <div id="partner-payments">
      </div>
    </div>
  </section>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const currentdate = new Date()

      let partnerList = [];
      let collect = 1;
      let status = 'active';

      const containerPartnerList = document.getElementById('partner-list');
      const partnerPaymentsContainer = document.getElementById('partner-payments');
      const collectSelect = document.getElementById('collect');
      const statusSelect = document.getElementById('status');

      const getPartners = async ({ collect, status }) => {
        partnerPaymentsContainer.innerHTML = ''
        partnerPaymentsContainer.style.display = 'none'

        try {
          const results = await window.electronAPI.getPartners({ collect, status });
          partnerList = results;
          renderPartnerList();
        } catch (error) {
          console.log(error);
        }
      };

      const renderPartnerList = () => {
        containerPartnerList.innerHTML = '';

        if (partnerList.length === 0) {
          containerPartnerList.innerHTML = `<p style="padding: 40px 20px; font-size: 18px">No hay socios${status == 'active' ? ' activos ' : ' pausados '} ${collect == 1 ? 'de secretaría parroquial' : 'del cobrador'}</p>`;
        } else {

          containerPartnerList.innerHTML = `
          <table class="partners-table" cellspacing="0">
            <thead>
              <tr>
                <td>Socio</td>
                <td>Último pago</td>
                <td>Pago del mes</td>
                <td>Opciones</td>
              </tr>
            </thead>
            <tbody id="partner-table-body">
            </tbody>
          </table>
          `
          const partnerTableBody = document.getElementById('partner-table-body');
          partnerTableBody.innerHTML = '';

          partnerList.forEach((e, i) => {
            const last_payment = e.last_payment_date ? new Date(e.last_payment_date).toLocaleDateString('es-ES', { year: 'numeric', month: 'short', day: 'numeric' }) : 'No realizó pagos'

            const paymentDate = new Date(e.last_payment_date);

            const paymentYear = paymentDate.getFullYear();
            const paymentMonth = paymentDate.getMonth();
            const currentYear = currentdate.getFullYear();
            const currentMonth = currentdate.getMonth();

            const tr = document.createElement('tr');

            // Crear y configurar la primera columna
            const tdName = document.createElement('td');
            tdName.setAttribute('data-id', e.id);
            tdName.title = e.name;

            const h4Name = document.createElement('h4');
            h4Name.innerText = e.name;

            const pMemberNumber = document.createElement('p');
            pMemberNumber.innerText = `Número de socio: ${e.member_number}`;

            tdName.appendChild(h4Name);
            tdName.appendChild(pMemberNumber);

            // Crear y configurar la segunda columna (monto y último pago)  
            const tdPayment = document.createElement('td');
            tdPayment.setAttribute('data-id', e.id);

            if (e.last_payment_amount) {
              const h4Amount = document.createElement('h4');
              h4Amount.innerText = '$' + formatNumber(e.last_payment_amount);
              tdPayment.appendChild(h4Amount);
            }

            const pLastPayment = document.createElement('p');
            pLastPayment.innerText = last_payment;
            tdPayment.appendChild(pLastPayment);

            // Crear y configurar la tercera columna (estado del pago)
            const tdPaymentStatus = document.createElement('td');
            tdPaymentStatus.setAttribute('data-id', e.id);

            if ((paymentYear === currentYear) && (paymentMonth === currentMonth)) {
              tdPaymentStatus.innerHTML = `
                  <h4>$${formatNumber(e.last_payment_amount)}</h4>
                  <p>${last_payment}</p>
                `
            } else {
              tdPaymentStatus.innerHTML = `<span>No realizado</span>`
            }

            // Crear y configurar la cuarta columna (botón de opciones)
            const tdActions = document.createElement('td');

            // Botón de opciones
            const btnOptions = document.createElement('button');
            btnOptions.className = 'btn';
            btnOptions.setAttribute('data-id', e.id);

            const iconOptions = document.createElement('i');
            iconOptions.className = 'fa-solid fa-ellipsis-vertical';
            btnOptions.appendChild(iconOptions);

            // Contenedor de opciones (inicialmente oculto)
            const divOptions = document.createElement('div');
            divOptions.className = 'partner-options';
            divOptions.id = `options-${e.id}`;
            divOptions.style.display = 'none';

            // Botones dentro de las opciones
            const btnEdit = document.createElement('button');
            btnEdit.innerHTML = '<i class="fa-regular fa-pen-to-square"></i> Editar datos';

            const btnGeneratePlan = document.createElement('button');
            btnGeneratePlan.innerHTML = '<i class="fa-regular fa-file"></i> Generar planilla';

            const btnPause = document.createElement('button');
            btnPause.innerHTML = '<i class="fa-regular fa-clock"></i> Pausar';

            const btnCancel = document.createElement('button');
            btnCancel.innerHTML = '<i class="fa-regular fa-circle-xmark"></i> Cancelar';

            // Agregar los botones al div de opciones
            divOptions.appendChild(btnEdit);
            divOptions.appendChild(btnGeneratePlan);
            divOptions.appendChild(btnPause);
            divOptions.appendChild(btnCancel);

            // Agregar el botón de opciones y el div de opciones a la columna de acciones
            tdActions.appendChild(btnOptions);
            tdActions.appendChild(divOptions);

            // Finalmente, agregar todas las celdas a la fila (tr)
            tr.appendChild(tdName);
            tr.appendChild(tdPayment);
            tr.appendChild(tdPaymentStatus);
            tr.appendChild(tdActions);

            // Agregar la fila al cuerpo de la tabla
            partnerTableBody.appendChild(tr);
          });

          document.querySelectorAll('.btn').forEach(button => {
            button.addEventListener('click', (event) => {
              const memberId = event.target.closest('.btn').getAttribute('data-id');
              const optionsDiv = document.getElementById(`options-${memberId}`);
              const icon = event.target.closest('.btn').querySelector('i');

              // Alternar visibilidad del menú de opciones
              if (optionsDiv.style.display === 'none') {
                closeAllMenus(); // Cierra otros menús abiertos
                optionsDiv.style.display = 'block';
                icon.classList.remove('fa-ellipsis-vertical');
                icon.classList.add('fa-xmark'); // Cambiar el icono a "X"
              } else {
                optionsDiv.style.display = 'none';
                icon.classList.remove('fa-xmark');
                icon.classList.add('fa-ellipsis-vertical'); // Cambiar el icono a elipsis
              }
            });
          });


          document.querySelectorAll('td[data-id]').forEach(td => {
            td.addEventListener('click', (event) => {
              const memberId = event.target.closest('td').getAttribute('data-id');
              loadPartnerPayments(memberId)
            });
          });

          // Función para cerrar todos los menús abiertos
          const closeAllMenus = () => {
            document.querySelectorAll('.partner-options').forEach(option => {
              option.style.display = 'none';
            });
            document.querySelectorAll('.btn i').forEach(icon => {
              icon.classList.remove('fa-xmark');
              icon.classList.add('fa-ellipsis-vertical');
            });
          };

          // Cerrar el menú si se hace clic fuera
          document.addEventListener('click', (event) => {
            if (!event.target.closest('.btn') && !event.target.closest('.partner-options')) {
              closeAllMenus();
            }
          });
        }

      };

      let currentId = ''

      const loadPartnerPayments = async (id) => {

        if (currentId != id) {
          currentId = id

          partnerPaymentsContainer.innerHTML = ''
          partnerPaymentsContainer.style.display = 'block'

          const year = currentdate.getFullYear().toString()

          const parnterName = document.createElement('h3')
          const memberNumber = document.createElement('span')
          const subtitle = document.createElement('h4')
          const form = document.createElement('form')
          const div = document.createElement('div')
          const divOptions = document.createElement('div')
          const p = document.createElement('p')
          const btnNewPayment = document.createElement('button')
          const btnPaymentOption1 = document.createElement('button')
          const btnPaymentOption2 = document.createElement('button')
          const btnPaymentOption3 = document.createElement('button')
          const inputNewPayment = document.createElement('input')

          try {
            const response = await window.electronAPI.getPartnerPayments({ id, year })

            const { partner, payments } = response

            parnterName.innerText = partner.name
            memberNumber.innerText = `Número de socio: ${partner.memberNumber}`
            subtitle.innerText = `Pagos del año ${year}`

            month = [
              'enero',
              'febrero',
              'marzo',
              'abril',
              'mayo',
              'junio',
              'julio',
              'agosto',
              'septiembre',
              'octubre',
              'noviembre',
              'diciembre',
            ]

            p.innerHTML = `Pago de <b>${month[currentdate.getMonth()]}</b>`

            inputNewPayment.type = 'number'
            inputNewPayment.placeholder = 'Monto'
            inputNewPayment.name = 'payment'
            inputNewPayment.required = true

            btnNewPayment.type = 'submit'
            btnNewPayment.innerText = 'Agregar pago'
            btnNewPayment.className = 'btn'

            btnPaymentOption1.type = 'button'
            btnPaymentOption2.type = 'button'
            btnPaymentOption3.type = 'button'
            btnPaymentOption1.innerText = '$3.000'
            btnPaymentOption2.innerText = '$5.000'
            btnPaymentOption3.innerText = '$10.000'

            partnerPaymentsContainer.appendChild(parnterName)
            partnerPaymentsContainer.appendChild(memberNumber)

            div.appendChild(inputNewPayment)
            div.appendChild(btnNewPayment)
            divOptions.appendChild(btnPaymentOption1)
            divOptions.appendChild(btnPaymentOption2)
            divOptions.appendChild(btnPaymentOption3)
            form.appendChild(p)
            form.appendChild(div)
            form.appendChild(divOptions)

            btnPaymentOption1.onclick = () => {
              inputNewPayment.value = 3000
            }

            btnPaymentOption2.onclick = () => {
              inputNewPayment.value = 5000
            }

            btnPaymentOption3.onclick = () => {
              inputNewPayment.value = 10000
            }

            form.onsubmit = (e) => {
              e.preventDefault()
              addPayment({ id, e })
              currentId = ''
              getPartners({ collect: collectSelect.value, status: statusSelect.value })
              loadPartnerPayments(id)
            }

            partnerPaymentsContainer.appendChild(form)
            partnerPaymentsContainer.appendChild(subtitle)

            if (payments.length == 0) {
              const noPayments = document.createElement('p')
              noPayments.className = 'no-payments'
              noPayments.innerText = `No hay pagos registrados del ${year}`
              partnerPaymentsContainer.appendChild(noPayments)
              return
            } else {

              let monthsPaid = []
              const calendar = document.createElement('div')
              calendar.className = 'calendar'

              payments.forEach(e => {

                const paymentDate = new Date(e.payment_date)
                monthsPaid[paymentDate.getMonth()] = paymentDate.getMonth()

                if (paymentDate.getMonth() == currentdate.getMonth()) {
                  form.style.display = 'none'
                  const p = document.createElement('p')
                  p.className = 'payment-notification'
                  p.innerHTML = `Mes de ${month[currentdate.getMonth()]} <b>PAGADO</b>`
                  partnerPaymentsContainer.appendChild(p)
                  partnerPaymentsContainer.appendChild(subtitle)
                }

              })

              generateCalendar(calendar, monthsPaid)


              partnerPaymentsContainer.appendChild(calendar)
            }

          } catch (error) {
            console.log(error)
          }
        }
      }

      collectSelect.addEventListener('change', (e) => {
        collect = e.target.value;
        getPartners({ collect, status });
      });

      statusSelect.addEventListener('change', (e) => {
        status = e.target.value;
        getPartners({ collect, status });
      });

      window.electronAPI.updatePartnerList((_, collectValue) => {
        collect = collectValue;
        collectSelect.value = collect;
        getPartners({ collect, status });
      });

      const generateCalendar = (calendar, monthsPaid) => {

        let i = 0

        while (i < 12) {
          if (monthsPaid[i] == i) {
            const divMonthPaid = document.createElement('div')
            divMonthPaid.innerHTML = `  
              <span>${month[i]}</span>
              <div style="background: #519819;"><i class="fa-solid fa-check"></i></div>
            `
            calendar.appendChild(divMonthPaid)
          } else {
            const divUnpaidMonth = document.createElement('div')
            divUnpaidMonth.innerHTML = `  
              <span>${month[i]}</span>
              <div></div>
            `
            calendar.appendChild(divUnpaidMonth)
          }

          i++
        }
      }

      getPartners({ collect, status });

    });

  </script>
  <script src="../scripts/openViewNewPartner.js"></script>
</body>

</html>